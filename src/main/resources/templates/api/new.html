<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Data-Hub</title>

    <th:block th:replace="fragments/head :: head"/>

    <style>
        .condition-list {
            overflow-y: scroll;
            height: 8rem;
        }
    </style>
    <script th:inline="javascript">
        function fetch_dataset_column(dataset) {
            const xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () { // 요청에 대한 콜백
                if (xhr.readyState === xhr.DONE) { // 요청이 완료되면
                    if (xhr.status === 200 || xhr.status === 201) {
                        const responseData = JSON.parse(xhr.responseText)['data'];
                        const dataset_column_selector = document.querySelector('#dataset-column > ul.condition-list');
                        dataset_column_selector.textContent = '';
                        responseData.forEach(column => {
                            console.log(column['columnEn'] + '/' + column['columnKr']);
                            let htmlliElement = document.createElement('li');
                            let htmlInputElement = document.createElement('input');
                            htmlInputElement.name = 'targetColumn';
                            htmlInputElement.type = 'checkbox';
                            htmlInputElement.value = column['columnEn'];
                            htmlInputElement.id = 'dataset_column_' + column['columnEn'];
                            htmlInputElement.checked = true;
                            let htmlLabelElement = document.createElement('label');
                            htmlLabelElement.classList.add('ms-1');
                            htmlLabelElement.htmlFor = htmlInputElement.id;
                            if (column['columnKr'])
                                htmlLabelElement.textContent = column['columnKr'];
                            else
                                htmlLabelElement.textContent = column['columnEn'];

                            htmlliElement.append(htmlInputElement);
                            htmlliElement.append(htmlLabelElement);
                            dataset_column_selector.append(htmlliElement);
                        });
                    } else {
                        console.error(xhr.responseText);
                    }
                }
            };
            xhr.open('GET', 'https://api.dataportal.kr/common/util/scheme/' + dataset); // 메소드와 주소 설정
            xhr.send(); // 요청 전송
        }

        window.onload = () => {
            document.getElementById('btn-dataset-search').addEventListener('click', () => {
                window.name = "parentForm";
                const openWin = window.open("/dataset/search",
                    "childForm", "width=570, height=350, resizable = no, scrollbars = no");
                openWin.addEventListener('unload', () => {
                    if (openWin.closed) {
                        document.getElementById('dataset-column').classList.remove('d-none');
                        fetch_dataset_column(document.getElementById('text-dataset-search').value);
                    }
                });
            });

            document.getElementById('select-permission').addEventListener('change', (evt) => {
                const ul_conditionList = document.getElementById('ul_condition-list');
                if (evt.target.selectedOptions[0].value === 'datahub') {
                    ul_conditionList.classList.remove('d-none');
                } else {
                    ul_conditionList.classList.add('d-none');
                }
            });
        }
    </script>
</head>

<body>
<div th:replace="fragments/header.html :: fragment-header (user=${user})"></div>
<div class="container">
    <div class="row">
        <div class="col-11 col-md-10 mx-auto">
            <form th:action="@{/api/new}" method="post">
                <input type="hidden" name="category1st" value="과학기술">
                <input type="hidden" name="category2nd" value="테스트">
                <input type="hidden" name="organization" value="테스트">
                <!-- API-name -->
                <h2>API 생성</h2>
                <div class="input-api-name mt-5">
                    <h4>API 이름</h4>
                    <input type="text" class="form-control" name="name" value="">
                </div>

                <div class="row">
                    <!-- API-use_dataset -->
                    <div class="col-12 mt-3">
                        <h4>대상 데이터셋</h4>
                        <div class="input-group">
                            <input type="text" readonly class="form-control" id="text-dataset-search"
                                   name="targetDataset">
                            <span class="btn btn-primary" id="btn-dataset-search">검색</span>
                        </div>
                    </div>
                    <!-- API-select-column -->
                    <div class="col-12 mt-3 d-none" id="dataset-column">
                        <h4>컬럼 선택</h4>
                        <ul class="condition-list border p-2 pt-0">
                        </ul>
                    </div>

                    <!-- API-explain -->
                    <div class="col-12 mt-3">
                        <h4>API 설명</h4>
                        <textarea class="col-12" rows="5" name="apiDesc"></textarea>
                    </div>

                    <!-- API-open_range -->
                    <div class="col-12 input-open-range justify-content-start mt-3">
                        <label for="select-permission" class="h4">공개 범위</label>
                        <select name="permissionGroup" id="select-permission" class="form-select">
                            <option value="PERMISSION_PUBLIC">전체공개</option>
                            <option value="PERMISSION_PRIVATE">비공개</option>
                            <option value="PERMISSION_DATAHUB">데이터허브</option>
                        </select>
                        <ul class="condition-list border p-2 pt-0 d-none" id="ul_condition-list">
                            <li th:each="item : ${datahub}">
                                <input name="own_datahub" type="checkbox" th:value="${item}"
                                       th:id="'own_datahub_' + ${item}">
                                <label th:text="${item}" th:for="'own_datahub_' + ${item}"></label>
                            </li>
                        </ul>
                    </div>

                    <!-- API-create_button -->
                    <div class="d-grid gap-1 mt-3">
                        <input type="submit" class="btn btn-primary" value="생성하기">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</body>

</html>